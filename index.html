<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tarot Petra Olivares - Realismo Total</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: #050208; 
            color: #f1c40f; 
            font-family: 'Georgia', serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
        }

        h1 { 
            text-align: center;
            padding: 8px 0;
            font-size: 1.2rem; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
            flex-shrink: 0;
        }
        
        .viewport-fix { 
            flex: 1; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            position: relative;
            perspective: 1200px; 
        }
        
        .mesa-tarot { 
            position: relative; 
            width: 900px; 
            height: 800px; 
            background: radial-gradient(circle, #1a0f2e 0%, #000 85%); 
            border-radius: 50%; 
            transform-origin: center center; 
            flex-shrink: 0;
            transform: rotateX(10deg); 
        }
        
        .slot { 
            position: absolute; 
            width: 140px; 
            height: 217px; 
            border: 1px solid #d4af37; 
            border-radius: 12px; 
            background: #111; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.9); 
            transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1), box-shadow 0.4s, top 0.6s, left 0.6s; 
            z-index: 5;
            touch-action: none;
            cursor: pointer;
            visibility: hidden;
        }
        .slot.visible { visibility: visible; }
        .slot img { width: 100%; height: 100%; object-fit: cover; display: none; }
        
        .is-back { background: linear-gradient(135deg, #2e1a47 0%, #000 100%) !important; border: 2px solid #f1c40f; position: relative; visibility: visible !important; }
        .is-back::after { content: "★"; color: rgba(241, 196, 15, 0.2); font-size: 2.5rem; }

        .invertida img { transform: rotate(180deg); }

        .slot.zoom {
            transform: scale(1.8) !important;
            z-index: 500 !important;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.5);
            border-color: #fff;
        }

        .en-mazo { left: 380px !important; top: 290px !important; visibility: visible !important; }
        #s0.en-mazo { transform: translateX(-65px) rotate(-25deg); z-index: 10; }
        #s1.en-mazo { transform: translateX(-50px) rotate(-20deg); z-index: 11; }
        #s2.en-mazo { transform: translateX(-35px) rotate(-15deg); z-index: 12; }
        #s3.en-mazo { transform: translateX(-18px) rotate(-10deg); z-index: 13; }
        #s4.en-mazo { transform: translateX(-5px) rotate(-5deg); z-index: 14; }
        #s5.en-mazo { transform: translateX(5px) rotate(5deg); z-index: 15; }
        #s6.en-mazo { transform: translateX(18px) rotate(10deg); z-index: 16; }
        #s7.en-mazo { transform: translateX(35px) rotate(15deg); z-index: 17; }
        #s8.en-mazo { transform: translateX(50px) rotate(20deg); z-index: 18; }
        #s9.en-mazo { transform: translateX(65px) rotate(25deg); z-index: 19; }

        .pos-celta-0 { left: 280px; top: 290px; z-index: 20; } 
        .pos-celta-1 { left: 280px; top: 290px; transform: rotate(90deg); z-index: 21; } 
        .pos-celta-2 { left: 280px; top: 560px; } 
        .pos-celta-3 { left: 40px; top: 290px; }  
        .pos-celta-4 { left: 520px; top: 290px; } 
        .pos-celta-5 { left: 280px; top: 20px; }  
        .pos-celta-6 { left: 720px; top: 560px; } 
        .pos-celta-7 { left: 720px; top: 380px; } 
        .pos-celta-8 { left: 720px; top: 200px; } 
        .pos-celta-9 { left: 720px; top: 20px; }

        .pos-preg-0 { left: 100px; top: 50px; }
        .pos-preg-1 { left: 290px; top: 30px; }
        .pos-preg-2 { left: 480px; top: 30px; }
        .pos-preg-3 { left: 670px; top: 50px; }

        .controles { 
            padding: 8px; display: flex; flex-direction: column; align-items: center; gap: 6px; 
            width: 100%; background: #000; z-index: 1000; border-top: 1px solid #1a0f2e; flex-shrink: 0;
        }
        #log { font-size: 0.8rem; color: #f1c40f; font-weight: bold; }
        .btn-group { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
        button { padding: 8px 12px; background: #1a0f2e; border: 1px solid #f1c40f; color: #f1c40f; font-weight: bold; cursor: pointer; border-radius: 4px; text-transform: uppercase; font-size: 0.75rem; transition: 0.3s; }
        button:disabled { opacity: 0.2; }
        .btn-danger { background: #4a0000; border-color: #ff4444; color: #ff4444; }

        /* MODALES */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 2000;
            display: none; flex-direction: column; padding: 15px; overflow-y: auto;
        }
        .header-modal { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1c40f; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* MODAL REINICIAR (ESTILO MÁGICO) */
        .modal-confirm {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center;
        }
        .pergamino {
            background: #1a0f2e; border: 2px solid #f1c40f; padding: 30px; border-radius: 20px;
            text-align: center; box-shadow: 0 0 30px #f1c40f44; max-width: 300px;
        }
        .pergamino h3 { color: #f1c40f; margin-bottom: 20px; letter-spacing: 2px; text-transform: uppercase; }
        
        /* GALERÍA DE MAZO */
        .galeria-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 15px; 
            padding: 10px; 
        }
        .galeria-item { text-align: center; font-size: 0.7rem; color: #d4af37; }
        .galeria-item img { width: 100%; border-radius: 5px; border: 1px solid #333; margin-bottom: 5px; }

        .wrapper-celta { position: relative; width: 900px; height: 800px; transform-origin: top left; margin-bottom: 20px; border: 1px solid #1a0f2e; background: rgba(20,10,30,0.3); border-radius: 20px; }
        .mini-slot { position: absolute; width: 130px; height: 190px; border: 1px solid #d4af37; border-radius: 8px; overflow: hidden; }
        .mini-slot img { width: 100%; height: 100%; object-fit: cover; }
        .mini-inv img { transform: rotate(180deg); }
        .grid-preguntas { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 800px; margin-bottom: 30px; }
        .card-pregunta { border: 1px solid #d4af37; border-radius: 5px; overflow: hidden; aspect-ratio: 2/3; }
        .card-pregunta img { width: 100%; height: 100%; object-fit: cover; }
        .card-pregunta.inv img { transform: rotate(180deg); }
        .seccion-titulo { color: #f1c40f; border-left: 4px solid #f1c40f; padding-left: 10px; margin: 25px 0 10px 0; text-transform: uppercase; font-size: 0.9rem; }
    </style>
</head>
<body>

<h1>Petra Olivares</h1>

<div class="viewport-fix">
    <div class="mesa-tarot" id="mesa">
        <script>
            for(let i=0; i<10; i++) document.write(`<div id="s${i}" class="slot is-back en-mazo" onmousedown="zoomIn(this)" onmouseup="zoomOut(this)" ontouchstart="zoomIn(this)" ontouchend="zoomOut(this)"></div>`);
        </script>
    </div>
</div>

<div class="controles">
    <div id="log">Iniciando mazo sagrado...</div>
    <div class="btn-group">
        <button id="btn-barajear" onclick="mezclar()">Barajear</button>
        <button id="btn-accion" disabled onclick="lanzar()">Invocar</button>
        <button onclick="toggleModal('modal-resumen')">Resumen</button>
        <button onclick="mostrarMazo()">Ver Mazo</button>
        <button class="btn-danger" onclick="abrirConfirmacion()">Reiniciar</button>
    </div>
</div>

<div id="modal-confirmar" class="modal-confirm">
    <div class="pergamino">
        <h3>¿REINICIAR TIRADAS?</h3>
        <div class="btn-group">
            <button onclick="ejecutarReinicio()">SÍ</button>
            <button class="btn-danger" onclick="cerrarConfirmacion()">NO</button>
        </div>
    </div>
</div>

<div id="modal-resumen" class="modal">
    <div class="header-modal">
        <h2>HISTORIAL DE LECTURA</h2>
        <button onclick="toggleModal('modal-resumen')">Cerrar</button>
    </div>
    <div id="resumen-content"></div>
</div>

<div id="modal-mazo" class="modal">
    <div class="header-modal">
        <h2>EL MAZO SAGRADO (78 CARTAS)</h2>
        <button onclick="toggleModal('modal-mazo')">Cerrar</button>
    </div>
    <div id="galeria-mazo" class="galeria-grid"></div>
</div>

<script>
    const USUARIO = "sanchezrodriguezdannyjose-byte"; 
    const REPOSITORIO = "TAROT";
    const BaseURL = `https://${USUARIO}.github.io/${REPOSITORIO}/`;
    const ApiURL = `https://api.github.com/repos/${USUARIO}/${REPOSITORIO}/contents/`;

    let mazoOriginal = [];
    let seleccionadas = [];
    let tiradasRealizadas = 0;
    let fase = "CELTA";

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(tipo) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); 
        gain.connect(audioCtx.destination);
        osc.type = 'triangle';

        if (tipo === 'shuffle') {
            osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        } else {
            osc.frequency.setValueAtTime(900, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.4);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.4);
        }
    }

    function zoomIn(el) { if (!el.classList.contains('is-back')) el.classList.add('zoom'); }
    function zoomOut(el) { el.classList.remove('zoom'); }

    // FUNCIONES DEL NUEVO MODAL MÁGICO
    function abrirConfirmacion() {
        document.getElementById('modal-confirmar').style.display = 'flex';
    }
    function cerrarConfirmacion() {
        document.getElementById('modal-confirmar').style.display = 'none';
    }
    function ejecutarReinicio() {
        cerrarConfirmacion();
        reiniciarConsulta();
    }

    async function obtenerNombresDelServidor() {
        try {
            const response = await fetch(ApiURL);
            const archivos = await response.json();
            mazoOriginal = archivos
                .filter(f => f.name.toLowerCase().match(/\.(jpg|jpeg|png|gif)$/))
                .map(f => f.name);
            document.getElementById('log').innerText = `Mazo Sincronizado: ${mazoOriginal.length} cartas.`;
        } catch (e) { document.getElementById('log').innerText = "Error al conectar con GitHub."; }
    }

    async function mezclar() {
        if (mazoOriginal.length < 4) return;
        playSound('shuffle');
        let cant = fase === "CELTA" ? 10 : 4;
        let mazoTemp = [...mazoOriginal].sort(() => Math.random() - 0.5);
        let elegidas = mazoTemp.slice(0, cant);
        seleccionadas = [];

        document.querySelectorAll('.slot').forEach((s, i) => {
            s.innerHTML = ''; 
            s.className = 'slot is-back en-mazo';
            s.style.visibility = i < cant ? 'visible' : 'hidden';
        });

        for(let i=0; i<cant; i++) {
            const nombre = elegidas[i];
            const img = new Image();
            img.src = BaseURL + encodeURIComponent(nombre);
            const invertida = Math.random() > 0.5;
            await new Promise(res => {
                img.onload = () => { seleccionadas[i] = { img, invertida, src: img.src }; res(); };
                img.onerror = () => res();
            });
        }
        document.getElementById('log').innerText = "Mazo mezclado. Presiona INVOCAR.";
        document.getElementById('btn-accion').disabled = false;
    }

    async function lanzar() {
        document.getElementById('btn-accion').disabled = true;
        document.getElementById('btn-barajear').disabled = true;
        let cant = fase === "CELTA" ? 10 : 4;

        for(let i=0; i<cant; i++) {
            const s = document.getElementById(`s${i}`);
            if(!seleccionadas[i]) continue;
            s.classList.remove('en-mazo');
            s.classList.add(fase === "CELTA" ? `pos-celta-${i}` : `pos-preg-${i}`);
            playSound('card');
            const { img, invertida } = seleccionadas[i];
            if(invertida) s.classList.add('invertida');
            s.appendChild(img);
            img.style.display = "block";
            s.classList.remove('is-back');
            s.classList.add('visible');
            await new Promise(r => setTimeout(r, 600));
        }
        guardarEnResumen();
        if (fase === "CELTA") {
            tiradasRealizadas++;
            if (tiradasRealizadas >= 3) {
                fase = "PREGUNTAS";
                document.getElementById('log').innerText = "Fase de Consultas Libres.";
                document.getElementById('btn-accion').innerText = "Consultar";
            } else {
                document.getElementById('log').innerText = `Lectura #${tiradasRealizadas} completada.`;
            }
        }
        document.getElementById('btn-barajear').disabled = false;
    }

    function reiniciarConsulta() {
        tiradasRealizadas = 0;
        fase = "CELTA";
        document.getElementById('resumen-content').innerHTML = '';
        document.getElementById('btn-accion').innerText = "Invocar";
        document.getElementById('btn-accion').disabled = true;
        document.getElementById('btn-barajear').disabled = false;
        document.querySelectorAll('.slot').forEach((s, i) => {
            s.innerHTML = '';
            s.className = 'slot is-back en-mazo';
            s.style.visibility = i < 10 ? 'visible' : 'hidden';
        });
        document.getElementById('log').innerText = "Sistema Reiniciado. Barajee de nuevo.";
    }

    function mostrarMazo() {
        const galeria = document.getElementById('galeria-mazo');
        galeria.innerHTML = '';
        mazoOriginal.sort().forEach(nombre => {
            const item = document.createElement('div');
            item.className = 'galeria-item';
            const limpiaNombre = nombre.replace(/\.[^/.]+$/, "").replace(/_/g, " ");
            item.innerHTML = `
                <img src="${BaseURL}${encodeURIComponent(nombre)}">
                <p>${limpiaNombre}</p>
            `;
            galeria.appendChild(item);
        });
        toggleModal('modal-mazo');
    }

    function toggleModal(id) {
        const m = document.getElementById(id);
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    }

    function guardarEnResumen() {
        const contenedor = document.getElementById('resumen-content');
        const seccion = document.createElement('div');
        const titulo = document.createElement('div');
        titulo.className = "seccion-titulo";
        titulo.innerText = fase === "CELTA" ? `Lectura Cruz Celta #${tiradasRealizadas + 1}` : "Consulta Libre";
        
        if (fase === "CELTA") {
            const wrapper = document.createElement('div');
            wrapper.className = "wrapper-celta";
            const pos = [{l:280, t:290, r:0}, {l:280, t:290, r:90}, {l:280, t:560, r:0}, {l:40, t:290, r:0}, {l:520, t:290, r:0}, {l:280, t:20, r:0}, {l:720, t:560, r:0}, {l:720, t:380, r:0}, {l:720, t:200, r:0}, {l:720, t:20, r:0}];
            seleccionadas.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = `mini-slot ${c.invertida ? 'mini-inv' : ''}`;
                div.style.left = pos[i].l + "px"; div.style.top = pos[i].t + "px";
                div.style.transform = `rotate(${pos[i].r}deg)`;
                div.innerHTML = `<img src="${c.src}">`;
                wrapper.appendChild(div);
            });
            const scale = (window.innerWidth - 40) / 900;
            if(scale < 1) wrapper.style.transform = `scale(${scale})`;
            wrapper.style.height = (800 * Math.min(scale, 1)) + "px";
            seccion.appendChild(titulo); seccion.appendChild(wrapper);
        } else {
            const grid = document.createElement('div');
            grid.className = "grid-preguntas";
            seleccionadas.forEach(c => {
                grid.innerHTML += `<div class="card-pregunta ${c.invertida ? 'inv' : ''}"><img src="${c.src}"></div>`;
            });
            seccion.appendChild(titulo); seccion.appendChild(grid);
        }
        contenedor.prepend(seccion);
    }

    function ajustar() {
        const mesa = document.getElementById('mesa');
        const cont = document.querySelector('.viewport-fix');
        const escala = Math.min(cont.clientWidth / 950, cont.clientHeight / 850, 1);
        mesa.style.transform = `rotateX(10deg) scale(${escala * 0.95})`;
    }

    window.onload = () => { ajustar(); obtenerNombresDelServidor(); };
    window.onresize = ajustar;
</script>
</body>
</html>
